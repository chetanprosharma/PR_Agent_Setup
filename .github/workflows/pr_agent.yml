on:
  pull_request:
    types: [opened, reopened, ready_for_review]
  issue_comment:
    types: [created]

jobs:
  pr_agent_job:
    if: ${{ github.event.sender.type != 'Bot' }}
    runs-on: self-hosted   # REQUIRED for Ollama

    permissions:
      issues: write
      pull-requests: write
      contents: write

    env:
      OLLAMA_BASE_URL: http://localhost:11434
      LITELLM_REQUEST_TIMEOUT: "300"
      LITELLM_TIMEOUT: "300"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ⬇️ ONLY THIS STEP IS CHANGED ⬇️
      - name: Run PR Agent (Custom Docker)
        run: |
          docker run --rm \
            --network=host \
            -e GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}" \
            -e OPENAI_KEY="${{ secrets.OPENAI_KEY }}" \
            -e OLLAMA_BASE_URL="http://localhost:11434" \
            -e LITELLM_TIMEOUT=300 \
            -e LITELLM_REQUEST_TIMEOUT=300 \
            -e PR_AGENT_MODEL="ollama/deepseek-coder:6.7b" \
            -e PR_AGENT_FALLBACK_MODELS='["ollama/qwen2.5-coder:7b","ollama/codellama:7b"]' \
            -e PR_AGENT_MAX_TOKENS=32768 \
            -e PR_AGENT_AUTO_REVIEW=true \
            -e PR_AGENT_AUTO_DESCRIBE=true \
            -e PR_AGENT_AUTO_IMPROVE=false \
            -e PR_AGENT_RESPOND_TO_COMMENTS=true \
            -e PR_AGENT_PR_ACTIONS='["opened","reopened","ready_for_review","commented"]' \
            qodoai/pr-agent:latest

